<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSVã‚µãƒãƒª YAML ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆå¤§å®¹é‡å¯¾å¿œï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <h2>ğŸ“Š CSVã‚µãƒãƒª YAML ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆå¤§å®¹é‡å¯¾å¿œï¼‰</h2>

  <p><strong>â‘  åˆ†æå¯¾è±¡ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼š</strong></p>
  <input type="file" id="csvFileInput" accept=".csv" /><br /><br />

  <p><strong>â‘¡ ã‚«ãƒ©ãƒ å®šç¾©CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆcsv, table, column_type ã®3åˆ—ï¼‰ï¼š</strong></p>
  <input type="file" id="columnDefInput" accept=".csv" /><br /><br />

  <button id="generateYamlButton" onclick="processFiles()">ğŸ“¥ YAMLç”Ÿæˆ</button>

  <script>
    function processFiles() {
      const csvFile = document.getElementById('csvFileInput').files[0];
      const defFile = document.getElementById('columnDefInput').files[0];

      const csvFileInput = document.getElementById('csvFileInput');
      const columnDefInput = document.getElementById('columnDefInput');
      const generateYamlButton = document.getElementById('generateYamlButton');

      csvFileInput.disabled = true;
      columnDefInput.disabled = true;
      generateYamlButton.disabled = true;

      if (!csvFile || !defFile) {
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚«ãƒ©ãƒ å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¡æ–¹æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      Papa.parse(defFile, {
        header: true,
        skipEmptyLines: true,
        complete: function (defResults) {
          const columnDefs = defResults.data.filter(row => row["csv"] && row["column_type"]);

          console.log("columnDefs: ", columnDefs);

          const targetColumns = columnDefs.map(row => ({
            name: row["csv"].trim(),
            type: row["column_type"].trim().toLowerCase()
          }));

          const summary = {};
          const baseKey = csvFile.name.replace(/\.csv$/, '');
          summary[baseKey] = {
            collection: { count: 0 },
            columns: {}
          };

          // åˆæœŸåŒ–ï¼šã‚«ãƒ©ãƒ ã”ã¨ã®é›†è¨ˆç”¨ãƒ‡ãƒ¼ã‚¿
          const colStats = {};
          targetColumns.forEach((col, idx) => {
            colStats[col.name] = {
              name: col.name,
              null_count: 0,
              value_counts: {},
              min_value: null,
              max_value: null,
              type: col.type
            };
          });

          // ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†é–‹å§‹
          Papa.parse(csvFile, {
            header: true,
            skipEmptyLines: true,
            worker: false,
            step: function (results) {
              const row = results.data;
              summary[baseKey].collection.count++;

              targetColumns.forEach(col => {
                const value = row[col.name].trim();
                const isEmpty = value === undefined || value === '';

                if (isEmpty) {
                  colStats[col.name].null_count++;
                } else {
                  // ã‚«ã‚¦ãƒ³ãƒˆ
                  colStats[col.name].value_counts[value] = (colStats[col.name].value_counts[value] || 0) + 1;

                  // min/max è¨ˆç®—
                  if (col.type === "number") {
                    const num = parseFloat(value);
                    if (!isNaN(num)) {
                      if (colStats[col.name].min_value === null || num < colStats[col.name].min_value)
                        colStats[col.name].min_value = num;
                      if (colStats[col.name].max_value === null || num > colStats[col.name].max_value)
                        colStats[col.name].max_value = num;
                    }
                  } else {
                    if (colStats[col.name].min_value === null || value < colStats[col.name].min_value)
                      colStats[col.name].min_value = value;
                    if (colStats[col.name].max_value === null || value > colStats[col.name].max_value)
                      colStats[col.name].max_value = value;
                  }
                }
              });
            },
            complete: function () {
              // çµ±è¨ˆå€¤ã®ã¾ã¨ã‚
              targetColumns.forEach((col, idx) => {
                const stat = colStats[col.name];
                const values = Object.keys(stat.value_counts);
                const colSummary = {
                  name: col.name,
                  min_value: stat.min_value !== null ? String(stat.min_value) : null,
                  max_value: stat.max_value !== null ? String(stat.max_value) : null,
                  null_count: stat.null_count,
                  value_type_count: values.length
                };

                if (values.length <= 50) {
                  // countã®é™é †ã€countãŒåŒã˜ã ã£ãŸã‚‰valueã®æ˜‡é †
                  values.sort((a, b) => {
                    const countA = stat.value_counts[a];
                    const countB = stat.value_counts[b];
                    if (countA !== countB) {
                      return countB - countA; // â‘  countæ˜‡é †
                    }
                    if (stat.type === "number") {
                      return parseFloat(a) - parseFloat(b); // â‘¡ æ•°å€¤ã¨ã—ã¦æ˜‡é †
                    } else {
                      return String(a).localeCompare(String(b)); // â‘¢ æ–‡å­—åˆ—æ˜‡é †ï¼ˆUnicodeé †ï¼‰
                    }
                  });

                  values.forEach((v, i) => {
                    colSummary[`value${i + 1}`] = {
                      value: v || null,
                      count: stat.value_counts[v]
                    };
                  });
                }

                summary[baseKey].columns[`column${idx + 1}`] = colSummary;
              });

              // YAMLå‡ºåŠ›
              const yamlText = jsyaml.dump(summary, { noRefs: true, sortKeys: false });
              const now = new Date();
              const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 14);
              const filename = `csv_summary_${baseKey}_${timestamp}.yaml`;
              downloadTextFile(yamlText, filename);

              // ãƒœã‚¿ãƒ³ã‚’å†æ´»æ€§åŒ–
              csvFileInput.disabled = false;
              columnDefInput.disabled = false;
              generateYamlButton.disabled = false;
            }
          });
        }
      });
    }

    function downloadTextFile(text, filename) {
      const blob = new Blob([text], { type: 'text/yaml' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
</body>
</html>
